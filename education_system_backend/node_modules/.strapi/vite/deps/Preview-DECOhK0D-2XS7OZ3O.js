import {
  getDocumentStatus
} from "./chunk-BCJDAX23.js";
import "./chunk-3KUCA3TB.js";
import "./chunk-5HA3U2WT.js";
import "./chunk-IKUKPS52.js";
import "./chunk-PEX7BVVP.js";
import "./chunk-ZTKHKMUB.js";
import "./chunk-TFV37TU3.js";
import "./chunk-YVP7U5AB.js";
import "./chunk-3TBNZ2ES.js";
import {
  COLLECTION_TYPES,
  DocumentRBAC,
  DocumentStatus,
  buildValidParams,
  useDocument,
  useDocumentLayout,
  useGetPreviewUrlQuery
} from "./chunk-G66GUQ25.js";
import "./chunk-TYFATMDP.js";
import "./chunk-RPX6VIML.js";
import "./chunk-LCPZ7C7U.js";
import "./chunk-RDRCFQEB.js";
import "./chunk-AOQUVGZ4.js";
import "./chunk-5Y4LIV3C.js";
import "./chunk-332DFF7K.js";
import {
  useClipboard,
  useHistory
} from "./chunk-5FBELZ4Y.js";
import {
  Page,
  createContext,
  useNotification,
  useQueryParams,
  useRBAC
} from "./chunk-MYYWVA3L.js";
import {
  Box,
  Flex,
  FocusTrap,
  Grid,
  IconButton,
  Portal$1,
  Tabs,
  Typography,
  require_lib,
  useIntl
} from "./chunk-J5WQOR5C.js";
import "./chunk-K5HTSSZO.js";
import {
  Link,
  useParams
} from "./chunk-ZBU7HZAS.js";
import "./chunk-ZKQH2XKQ.js";
import {
  ForwardRef$2l,
  ForwardRef$3$
} from "./chunk-I3NJTPHE.js";
import {
  require_jsx_runtime
} from "./chunk-LKGKRGZK.js";
import {
  dt
} from "./chunk-PVVMMKVV.js";
import {
  require_react
} from "./chunk-BM2TI6AS.js";
import {
  __toESM
} from "./chunk-WGAPYIUP.js";

// node_modules/@strapi/content-manager/dist/_chunks/Preview-DECOhK0D.mjs
var import_jsx_runtime = __toESM(require_jsx_runtime(), 1);
var React = __toESM(require_react(), 1);
var import_qs = __toESM(require_lib(), 1);
var PreviewContent = () => {
  const previewUrl = usePreviewContext("PreviewContent", (state) => state.url);
  const { formatMessage } = useIntl();
  return (0, import_jsx_runtime.jsx)(
    Box,
    {
      src: previewUrl,
      title: formatMessage({
        id: "content-manager.preview.panel.title",
        defaultMessage: "Preview"
      }),
      width: "100%",
      height: "100%",
      borderWidth: 0,
      tag: "iframe"
    },
    previewUrl
  );
};
var ClosePreviewButton = () => {
  const [{ query }] = useQueryParams();
  const { formatMessage } = useIntl();
  const canGoBack = useHistory("BackButton", (state) => state.canGoBack);
  const goBack = useHistory("BackButton", (state) => state.goBack);
  const history = useHistory("BackButton", (state) => state.history);
  const locationIndex = useHistory("BackButton", (state) => state.currentLocationIndex);
  const historyTo = canGoBack ? history.at(locationIndex - 2) : void 0;
  const fallback = {
    pathname: "..",
    search: (0, import_qs.stringify)(query, { encode: false })
  };
  const toWithFallback = historyTo ?? fallback;
  const handleClick = (e) => {
    if (canGoBack) {
      e.preventDefault();
      goBack();
      return;
    }
  };
  return (0, import_jsx_runtime.jsx)(
    IconButton,
    {
      tag: Link,
      relative: "path",
      to: toWithFallback,
      onClick: handleClick,
      label: formatMessage({
        id: "content-manager.preview.header.close",
        defaultMessage: "Close preview"
      }),
      children: (0, import_jsx_runtime.jsx)(ForwardRef$3$, {})
    }
  );
};
var Status = () => {
  var _a;
  const document = usePreviewContext("PreviewHeader", (state) => state.document);
  const schema = usePreviewContext("PreviewHeader", (state) => state.schema);
  const meta = usePreviewContext("PreviewHeader", (state) => state.meta);
  const hasDraftAndPublished = ((_a = schema == null ? void 0 : schema.options) == null ? void 0 : _a.draftAndPublish) ?? false;
  if (!hasDraftAndPublished) {
    return null;
  }
  const status = getDocumentStatus(document, meta);
  return (0, import_jsx_runtime.jsx)(DocumentStatus, { status, size: "XS" });
};
var PreviewTabs = () => {
  var _a;
  const { formatMessage } = useIntl();
  const [{ query }, setQuery] = useQueryParams();
  const document = usePreviewContext("PreviewHeader", (state) => state.document);
  const schema = usePreviewContext("PreviewHeader", (state) => state.schema);
  const meta = usePreviewContext("PreviewHeader", (state) => state.meta);
  const hasDraftAndPublish = ((_a = schema == null ? void 0 : schema.options) == null ? void 0 : _a.draftAndPublish) ?? false;
  const documentStatus = getDocumentStatus(document, meta);
  const handleTabChange = (status) => {
    if (status === "published" || status === "draft") {
      setQuery({ status }, "push", true);
    }
  };
  if (!hasDraftAndPublish) {
    return null;
  }
  return (0, import_jsx_runtime.jsx)(import_jsx_runtime.Fragment, { children: (0, import_jsx_runtime.jsx)(Tabs.Root, { variant: "simple", value: query.status || "draft", onValueChange: handleTabChange, children: (0, import_jsx_runtime.jsxs)(
    Tabs.List,
    {
      "aria-label": formatMessage({
        id: "preview.tabs.label",
        defaultMessage: "Document status"
      }),
      children: [
        (0, import_jsx_runtime.jsx)(StatusTab, { value: "draft", children: formatMessage({
          id: "content-manager.containers.List.draft",
          defaultMessage: "draft"
        }) }),
        (0, import_jsx_runtime.jsx)(StatusTab, { value: "published", disabled: documentStatus === "draft", children: formatMessage({
          id: "content-manager.containers.List.published",
          defaultMessage: "published"
        }) })
      ]
    }
  ) }) });
};
var PreviewHeader = () => {
  const mainField = usePreviewContext("PreviewHeader", (state) => state.mainField);
  const document = usePreviewContext("PreviewHeader", (state) => state.document);
  const schema = usePreviewContext("PreviewHeader", (state) => state.schema);
  let documentTitle = "Untitled";
  if (mainField !== "id" && (document == null ? void 0 : document[mainField])) {
    documentTitle = document[mainField];
  } else if (schema.kind === "singleType" && (schema == null ? void 0 : schema.info.displayName)) {
    documentTitle = schema.info.displayName;
  }
  const { formatMessage } = useIntl();
  const { toggleNotification } = useNotification();
  const { copy } = useClipboard();
  const handleCopyLink = () => {
    copy(window.location.href);
    toggleNotification({
      message: formatMessage({
        id: "content-manager.preview.copy.success",
        defaultMessage: "Copied preview link"
      }),
      type: "success"
    });
  };
  return (0, import_jsx_runtime.jsxs)(
    Grid.Root,
    {
      gap: 3,
      gridCols: 3,
      paddingLeft: 2,
      paddingRight: 2,
      background: "neutral0",
      borderColor: "neutral150",
      tag: "header",
      children: [
        (0, import_jsx_runtime.jsxs)(Grid.Item, { xs: 1, paddingTop: 2, paddingBottom: 2, gap: 3, children: [
          (0, import_jsx_runtime.jsx)(ClosePreviewButton, {}),
          (0, import_jsx_runtime.jsx)(PreviewTitle, { tag: "h1", fontWeight: 600, fontSize: 2, maxWidth: "200px", title: documentTitle, children: documentTitle }),
          (0, import_jsx_runtime.jsx)(Status, {})
        ] }),
        (0, import_jsx_runtime.jsx)(Grid.Item, { xs: 1, marginBottom: "-1px", alignItems: "end", margin: "auto", children: (0, import_jsx_runtime.jsx)(PreviewTabs, {}) }),
        (0, import_jsx_runtime.jsx)(Grid.Item, { xs: 1, justifyContent: "end", paddingTop: 2, paddingBottom: 2, children: (0, import_jsx_runtime.jsx)(
          IconButton,
          {
            type: "button",
            label: formatMessage({
              id: "preview.copy.label",
              defaultMessage: "Copy preview link"
            }),
            onClick: handleCopyLink,
            children: (0, import_jsx_runtime.jsx)(ForwardRef$2l, {})
          }
        ) })
      ]
    }
  );
};
var PreviewTitle = dt(Typography)`
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`;
var StatusTab = dt(Tabs.Trigger)`
  text-transform: uppercase;
`;
var [PreviewProvider, usePreviewContext] = createContext("PreviewPage");
var PreviewPage = () => {
  var _a, _b;
  const { formatMessage } = useIntl();
  const {
    slug: model,
    id: documentId,
    collectionType
  } = useParams();
  const [{ query }] = useQueryParams();
  const params = React.useMemo(() => buildValidParams(query), [query]);
  if (!collectionType) {
    throw new Error("Could not find collectionType in url params");
  }
  if (!model) {
    throw new Error("Could not find model in url params");
  }
  if (collectionType === COLLECTION_TYPES && !documentId) {
    throw new Error("Could not find documentId in url params");
  }
  const previewUrlResponse = useGetPreviewUrlQuery({
    params: {
      contentType: model
    },
    query: {
      documentId,
      locale: params.locale,
      status: params.status
    }
  });
  const documentResponse = useDocument({
    model,
    collectionType,
    documentId,
    params
  });
  const documentLayoutResponse = useDocumentLayout(model);
  if (documentResponse.isLoading || previewUrlResponse.isLoading || documentLayoutResponse.isLoading) {
    return (0, import_jsx_runtime.jsx)(Page.Loading, {});
  }
  if (previewUrlResponse.error || documentLayoutResponse.error || !documentResponse.document || !documentResponse.meta || !documentResponse.schema) {
    return (0, import_jsx_runtime.jsx)(Page.Error, {});
  }
  if (!((_b = (_a = previewUrlResponse.data) == null ? void 0 : _a.data) == null ? void 0 : _b.url)) {
    return (0, import_jsx_runtime.jsx)(Page.NoData, {});
  }
  return (0, import_jsx_runtime.jsxs)(import_jsx_runtime.Fragment, { children: [
    (0, import_jsx_runtime.jsx)(Page.Title, { children: formatMessage(
      {
        id: "content-manager.preview.page-title",
        defaultMessage: "{contentType} preview"
      },
      {
        contentType: documentLayoutResponse.edit.settings.displayName
      }
    ) }),
    (0, import_jsx_runtime.jsx)(
      PreviewProvider,
      {
        url: previewUrlResponse.data.data.url,
        mainField: documentLayoutResponse.edit.settings.mainField,
        document: documentResponse.document,
        meta: documentResponse.meta,
        schema: documentResponse.schema,
        children: (0, import_jsx_runtime.jsxs)(Flex, { direction: "column", height: "100%", alignItems: "stretch", children: [
          (0, import_jsx_runtime.jsx)(PreviewHeader, {}),
          (0, import_jsx_runtime.jsx)(PreviewContent, {})
        ] })
      }
    )
  ] });
};
var ProtectedPreviewPageImpl = () => {
  const { slug: model } = useParams();
  const {
    permissions = [],
    isLoading,
    error
  } = useRBAC([{ action: "plugin::content-manager.explorer.read", subject: model }]);
  if (isLoading) {
    return (0, import_jsx_runtime.jsx)(Page.Loading, {});
  }
  if (error || !model) {
    return (0, import_jsx_runtime.jsx)(
      Box,
      {
        height: "100vh",
        width: "100vw",
        position: "fixed",
        top: 0,
        left: 0,
        zIndex: 2,
        background: "neutral0",
        children: (0, import_jsx_runtime.jsx)(Page.Error, {})
      }
    );
  }
  return (0, import_jsx_runtime.jsx)(
    Box,
    {
      height: "100vh",
      width: "100vw",
      position: "fixed",
      top: 0,
      left: 0,
      zIndex: 2,
      background: "neutral0",
      children: (0, import_jsx_runtime.jsx)(Page.Protect, { permissions, children: ({ permissions: permissions2 }) => (0, import_jsx_runtime.jsx)(DocumentRBAC, { permissions: permissions2, children: (0, import_jsx_runtime.jsx)(PreviewPage, {}) }) })
    }
  );
};
var ProtectedPreviewPage = () => {
  return (0, import_jsx_runtime.jsx)(Portal$1, { children: (0, import_jsx_runtime.jsx)(FocusTrap, { children: (0, import_jsx_runtime.jsx)(ProtectedPreviewPageImpl, {}) }) });
};
export {
  ProtectedPreviewPage,
  usePreviewContext
};
//# sourceMappingURL=Preview-DECOhK0D-2XS7OZ3O.js.map
